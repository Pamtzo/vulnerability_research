# Security Audit Report - PonziContract

## 1. Bigger Vulnerabilities

- **Join Ponzi Function:** The `joinPonzi` function allows users to provide a list of addresses that will receive the money. This design flaw lets users affiliate themselves by just paying gas fees. To address this, the function should use the `affiliates_` array exclusively, ensuring that only genuine affiliates can receive funds.
  **Recommendation:** Modify the `joinPonzi` function to only distribute funds to addresses from the `affiliates_` array. Reject transactions that provide a list of addresses.

- **Withdraw Funds Vulnerability:** The `ownerWithdraw` function lacks protection against reentrancy attacks, even though it's currently designed to be called only by the contract owner. Although the design prevents unauthorized access, avoiding reentrancy in all functions is a good practice to ensure robust security.
  **Recommendation:** Add the `nonReentrant` modifier to the `ownerWithdraw` function as well, to guard against any potential future changes in the contract.

## 2. Other Issues

- **Gas Efficiency of onlyAfilliates Modifier:** The `onlyAfilliates` modifier iterates over the `affiliates_` list to check if the sender is an affiliate. This can be optimized by using the `affiliates` mapping, reducing gas consumption.
  **Recommendation:** Modify the `onlyAfilliates` modifier to use the `affiliates` mapping to check affiliate status.

- **Registration Deadline Security:** Using the block timestamp for the `registrationDeadline` can lead to potential manipulation through mining. Miners can slightly adjust the timestamp to exploit time-based conditions.
  **Recommendation:** Consider using block numbers for time-sensitive conditions. This provides a more secure and predictable mechanism.

- **Security of buyOwnerRole Function:** The `buyOwnerRole` function allows any user to buy the owner role by sending the required Ether. However, it doesn't account for the fact that the contract retains the funds. This could be exploited by any user with enough funds, leading to unintended consequences.
  **Recommendation:** Review the design of the `buyOwnerRole` function and the implications of retaining the funds within the contract. Depending on the contract's purpose, a different mechanism may be required to handle ownership transfer.

## How to run

If you go over the test and `contracts/MaliciousContract` both cases are explained

- In the first case the attacker joins the Ponzi Scheme but abuses the fact that he can give his own address to join the Ponzi Scheme, being added just using gas fees

- In second case after joining, attacker buys the owner role, and withdraw funds, nevertheless the contract he uses to withdraw, executes another withdraw transaction before the first ones finishes, this process ocurrs recursively until ponziContract losses all the funds

To run this test execute the `setup.sh` file it will

- Install dependencies
- Compile the contracts
- Run the tests

## Summary and Conclusion

The PonziContract contains vulnerabilities that could lead to unintended consequences. Addressing these vulnerabilities is crucial to ensure the security and intended functionality of the contract. The design of functions and protection mechanisms should be carefully reviewed, and improvements made based on the recommendations provided in this report. Always ensure comprehensive testing and due diligence when deploying smart contracts to ensure robust security.

Please note that this report is based on the information available at the time of analysis and might not cover all possible scenarios. Additional security measures and considerations beyond those mentioned here may be necessary based on the contract's specific use case and requirements.
